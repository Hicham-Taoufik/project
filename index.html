<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Dashboard - Médecin</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <style>
    :root {
      --primary: #5d74f2;
      --primary-light: #ebeffe;
      --primary-dark: #4a62d8;
      --success: #31c971;
      --success-light: #e0fbea;
      --success-dark: #28a960;
      --warning: #ffb648;
      --warning-light: #fff8ec;
      --danger: #ff5a5a;
      --danger-light: #ffeded;
      --gray-100: #f9fafb;
      --gray-200: #f1f3f9;
      --gray-300: #e5e7eb;
      --gray-400: #d1d5db;
      --gray-500: #9ca3af;
      --gray-600: #6b7280;
      --gray-700: #4b5563;
      --gray-800: #374151;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.04);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.05),0 4px 6px -2px rgba(0,0,0,0.05);
      --shadow-focus: 0 0 0 3px rgba(93,116,242,0.2);
      --border-radius: 8px;
      --transition-speed: 0.2s;
      font-size: 15px;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Inter',sans-serif; background:var(--gray-100); color:var(--gray-800); min-height:100vh; visibility:hidden; line-height:1.5; }
    body.loaded { visibility:visible; animation:fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    .container { max-width:1200px; margin:0 auto; padding:0 20px; }
    .flex-row { display:flex; gap:25px; flex-wrap:wrap; margin-bottom:25px; }
    .flex-col { flex:1; min-width:320px; }
    .card { background:white; border-radius:var(--border-radius); box-shadow:var(--shadow-md); transition:box-shadow var(--transition-speed) ease; overflow:hidden; }
    .card:hover { box-shadow:var(--shadow-lg); }
    .card-header { display:flex; align-items:center; padding:14px 16px; border-bottom:1px solid var(--gray-200); }
    .card-title { display:flex; align-items:center; font-size:1rem; font-weight:600; margin-left:8px; }
    .card-title i { margin-right:8px; color:var(--primary); }
    .card-body { padding:16px; }
    textarea, input[type="text"] {
      width:100%;
      padding:10px 12px;
      font-size:1rem;
      border:1px solid var(--gray-300);
      border-radius:var(--border-radius);
      background:white;
      font-family:'Inter',sans-serif;
      min-height:150px;
      transition:border-color var(--transition-speed) ease;
    }
    .btn-group { display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; }
    .btn { display:inline-flex; align-items:center; gap:6px; padding:10px 16px; font-size:1rem; font-weight:500; border:none; border-radius:var(--border-radius); cursor:pointer; transition:background var(--transition-speed) ease; }
    .btn-outline { background:white; color:var(--primary); border:1px solid var(--primary); }
    .btn-outline:hover { background:var(--primary); color:white; }
    .btn-success { background:var(--success); color:white; }
    .btn-success:hover { background:var(--success-dark); }
    .status { margin-left:6px; font-size:0.9rem; color:var(--gray-600); display:inline-flex; align-items:center; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Row 1: Antécédents & Diagnostic -->
    <div class="flex-row">
      <div class="flex-col">
        <div class="card">
          <div class="card-header">
            <i class="fas fa-history"></i>
            <h2 class="card-title">Antécédents</h2>
          </div>
          <div class="card-body" id="antecedentsCardBody">
            <textarea id="antecedentsInput" placeholder="Entrez les antécédents..."></textarea>
            <div class="btn-group">
              <button class="btn btn-outline" id="startAntecedentsRecordBtn"><i class="fas fa-microphone"></i> Démarrer</button>
              <button class="btn btn-outline" id="stopAntecedentsRecordBtn"><i class="fas fa-stop-circle"></i> Arrêter</button>
              <span class="status" id="antecedentsStatus"></span>
            </div>
          </div>
        </div>
      </div>
      <div class="flex-col">
        <div class="card">
          <div class="card-header">
            <i class="fas fa-stethoscope"></i>
            <h2 class="card-title">Diagnostic</h2>
          </div>
          <div class="card-body" id="diagCardBody">
            <textarea id="diagnosticInput" placeholder="Entrez le diagnostic..."></textarea>
            <div class="btn-group">
              <button class="btn btn-outline" id="startDiagRecordBtn"><i class="fas fa-microphone"></i> Démarrer</button>
              <button class="btn btn-outline" id="stopDiagRecordBtn"><i class="fas fa-stop-circle"></i> Arrêter</button>
              <span class="status" id="diagnosisStatus"></span>
            </div>
            <div class="btn-group">
              <button class="btn btn-success" id="submitDiagBtn"><i class="fas fa-check-circle"></i> Enregistrer</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Row 2: Prescription & Conseils -->
    <div class="flex-row">
      <div class="flex-col">
        <div class="card">
          <div class="card-header">
            <i class="fas fa-prescription-bottle-alt"></i>
            <h2 class="card-title">Prescription</h2>
          </div>
          <div class="card-body" id="prescCardBody">
            <textarea id="prescriptionInput" placeholder="Entrez la prescription..."></textarea>
            <div class="btn-group">
              <button class="btn btn-outline" id="startPrescRecordBtn"><i class="fas fa-microphone"></i> Démarrer</button>
              <button class="btn btn-outline" id="stopPrescRecordBtn"><i class="fas fa-stop-circle"></i> Arrêter</button>
              <span class="status" id="prescriptionStatus"></span>
            </div>
            <div class="btn-group">
              <button class="btn btn-success" id="submitPrescBtn"><i class="fas fa-robot"></i> Soumettre IA</button>
            </div>
          </div>
        </div>
      </div>
      <div class="flex-col">
        <div class="card">
          <div class="card-header">
            <i class="fas fa-lightbulb"></i>
            <h2 class="card-title">Conseils</h2>
          </div>
          <div class="card-body" id="treatmentCardBody">
            <textarea id="treatmentInput" placeholder="Entrez les conseils..."></textarea>
            <div class="btn-group">
              <button class="btn btn-outline" id="startTreatmentRecordBtn"><i class="fas fa-microphone"></i> Démarrer</button>
              <button class="btn btn-outline" id="stopTreatmentRecordBtn"><i class="fas fa-stop-circle"></i> Arrêter</button>
              <span class="status" id="treatmentStatus"></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Row 3: Notes, Orientation, Exploration -->
    <div class="flex-row">
      <div class="flex-col">
        <div class="card">
          <div class="card-header">
            <i class="fas fa-file-alt"></i>
            <h2 class="card-title">Notes</h2>
          </div>
          <div class="card-body" id="notesCardBody">
            <textarea id="notesInput" placeholder="Entrez les notes..."></textarea>
            <div class="btn-group">
              <button class="btn btn-outline" id="startNotesRecordBtn"><i class="fas fa-microphone"></i> Démarrer</button>
              <button class="btn btn-outline" id="stopNotesRecordBtn"><i class="fas fa-stop-circle"></i> Arrêter</button>
              <span class="status" id="notesStatus"></span>
            </div>
          </div>
        </div>
      </div>
      <div class="flex-col">
        <div class="card">
          <div class="card-header">
            <i class="fas fa-map-signs"></i>
            <h2 class="card-title">Orientation</h2>
          </div>
          <div class="card-body" id="orientationCardBody">
            <textarea id="orientationInput" placeholder="Entrez l'orientation..."></textarea>
            <div class="btn-group">
              <button class="btn btn-outline" id="startOrientationRecordBtn"><i class="fas fa-microphone"></i> Démarrer</button>
              <button class="btn btn-outline" id="stopOrientationRecordBtn"><i class="fas fa-stop-circle"></i> Arrêter</button>
              <span class="status" id="orientationStatus"></span>
            </div>
          </div>
        </div>
      </div>
      <div class="flex-col">
        <div class="card">
          <div class="card-header">
            <i class="fas fa-microscope"></i>
            <h2 class="card-title">Exploration</h2>
          </div>
          <div class="card-body" id="explorationCardBody">
            <textarea id="explorationInput" placeholder="Entrez l'exploration..."></textarea>
            <div class="btn-group">
              <button class="btn btn-outline" id="startExplorationRecordBtn"><i class="fas fa-microphone"></i> Démarrer</button>
              <button class="btn btn-outline" id="stopExplorationRecordBtn"><i class="fas fa-stop-circle"></i> Arrêter</button>
              <span class="status" id="explorationStatus"></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Submit Everything -->
    <div style="text-align:center; margin:20px 0;">
      <button id="submitAllBtn" class="btn btn-success"><i class="fas fa-upload"></i> Soumettre Toutes les Données</button>
      <span class="status" id="validationMessage"></span>
    </div>
  </div>

  <!-- jsQR + Full JavaScript -->
  <script src="./jsQR.js"></script>
  <script>
    // Enable/disable full dictation area
    function enableFullDictationSection(enable) {
      const full = document.getElementById("fullDictationCardBody");
      if(enable && currentIPP && currentVisitId){
        full.style.opacity='1';
        full.style.pointerEvents='auto';
        document.getElementById("startFullDictationRecordBtn").disabled=false;
        document.getElementById("stopFullDictationRecordBtn").disabled=false;
      } else {
        full.style.opacity='0.5';
        full.style.pointerEvents='none';
        document.getElementById("startFullDictationRecordBtn").disabled=true;
        document.getElementById("stopFullDictationRecordBtn").disabled=true;
      }
    }

    // Date conversions
    function convertToFrenchDate(s){
      if(!s||!/^\d{2}\/\d{2}\/\d{4}$/.test(s))return"";
      const [m,d,y]=s.split("/");
      return d+"/"+m+"/"+y;
    }
    function convertFrenchToBackendDate(s){
      if(!s||!/^\d{2}\/\d{2}\/\d{4}$/.test(s))return"";
      const [d,m,y]=s.split("/");
      return m+"/"+d+"/"+y;
    }

    // Config & globals
    const BASE_URL='https://workflows.aphelionxinnovations.com';
    const LOGIN_PAGE_URL='https://hicham-taoufik.github.io/login/';
    const QR_TARGET_BASE_URL='app://medilink/patient';
    const GET_PATIENT_DATA_ENDPOINT="/webhook/doctor/get-visit-details";
    const UPDATE_DIAGNOSIS_ENDPOINT="/webhook/doctor-submit-diagnostic";
    const TRANSCRIBE_DIAGNOSIS_ENDPOINT="/webhook/transcribe-diagnosis";
    const TRANSCRIBE_PRESCRIPTION_ENDPOINT="/webhook/transcribe-prescription";
    const SUBMIT_PRESCRIPTION_AI_ENDPOINT="/webhook/doctor-submit-prescription";
    const VALIDATE_PRESCRIPTION_AI_ENDPOINT="/webhook/doctor-validate-prescription";
    const TRANSCRIBE_NOTES_ENDPOINT="/webhook/transcribe-notes";
    const TRANSCRIBE_ORIENTATION_ENDPOINT="/webhook/transcribe-orientation";
    const TRANSCRIBE_ANTECEDENTS_ENDPOINT="/webhook/transcribe-antecedents";
    const TRANSCRIBE_TREATMENT_ENDPOINT="/webhook/transcribe-treatment";
    const TRANSCRIBE_EXPLORATION_ENDPOINT="/webhook/transcribe-exploration";
    const PROCESS_VISIT_DICTATION_ENDPOINT="/webhook/process-visit-dictation";

    let currentIPP=null, currentVisitId=null, mediaRecorder, audioChunks=[], recordingField=null;
    let scanning=false, currentStream=null, scanTimeout=null;
    const patientInfoDiv=document.getElementById('patientInfo');
    const nurseDataDisplayDiv=document.getElementById('nurseDataDisplay');
    const scanButton=document.getElementById('scanQrButton');
    const scannerContainer=document.getElementById('scanner-container');
    const video=document.getElementById('scanner-video');
    const aiSuggestionDiv=document.getElementById('aiSuggestion');

    // Fetch with auth wrapper
    function fetchWithAuth(url,options={}){
      const token=localStorage.getItem('authToken');
      if(!token){ alert('Session expirée.'); window.location.href=LOGIN_PAGE_URL; return Promise.reject();}
      const headers={...options.headers,'Authorization':`Bearer ${token}`};
      if(options.body&&! (options.body instanceof FormData)) headers['Content-Type']='application/json';
      else if(options.body instanceof FormData) delete headers['Content-Type'];
      return fetch(url,{...options,headers})
        .then(async res=>{
          if(res.status===401||res.status===403){
            localStorage.removeItem('authToken');
            alert('Session invalide.');
            window.location.href=LOGIN_PAGE_URL;
            throw new Error('Auth');
          }
          if(!res.ok){
            let err=await res.text();
            try{err=JSON.parse(err).message}catch{}
            throw new Error(err||res.statusText);
          }
          const ct=res.headers.get("content-type");
          const text=await res.text();
          if(ct&&ct.includes("application/json")){
            try{return JSON.parse(text);}catch{return{text};}
          }
          return {success:true,data:text};
        });
    }

    function logout(){
      localStorage.removeItem('authToken');
      alert('Déconnecté.');
      window.location.href=LOGIN_PAGE_URL;
    }

    function showMessage(id,msg,type='info'){
      const el=document.getElementById(id);
      if(!el)return;
      const icons={info:'fas fa-info-circle',success:'fas fa-check-circle',warning:'fas fa-exclamation-triangle',error:'fas fa-times-circle',loading:'fas fa-spinner fa-spin'};
      const icon=icons[type]||icons.info;
      el.innerHTML=msg?`<i class="${icon}" style="margin-right:6px"></i>${msg}`:"";
      el.style.display=msg?'inline-flex':'none';
      el.className='status';
      if(type==='success')el.style.color='var(--success)';
      if(type==='error')el.style.color='var(--danger)';
      if(type==='warning')el.style.color='var(--warning)';
    }

    function sanitizeInput(input){
      if(input==null)return"";
      const tmp=document.createElement('div');
      tmp.textContent=input;
      return tmp.innerHTML;
    }

    function formatDate(s,includeTime=false){
      if(!s||typeof s!=='string')return'-';
      const d=new Date(s);
      if(isNaN(d))return'Date Invalide';
      const opts={year:'numeric',month:'2-digit',day:'2-digit'};
      if(includeTime){opts.hour='2-digit';opts.minute='2-digit';delete opts.timeZone;}
      else opts.timeZone='UTC';
      return includeTime?d.toLocaleString('fr-FR',opts):d.toLocaleDateString('fr-FR',opts);
    }

    // SUBMIT ALL
    function submitAllData(){
      const data={
        ipp:currentIPP,
        visit_id:currentVisitId,
        dictation_global:"",
        diagnostic:document.getElementById("diagnosticInput").value||"",
        prescription:document.getElementById("prescriptionInput").value||"",
        notes:document.getElementById("notesInput").value||"",
        orientation:document.getElementById("orientationInput").value||"",
        antecedents:document.getElementById("antecedentsInput").value||"",
        treatment:document.getElementById("treatmentInput").value||"",
        exploration:document.getElementById("explorationInput").value||""
      };
      document.getElementById("submitAllBtn").disabled=true;
      fetch(`${BASE_URL}/webhook/doctor-submit-all`,{
        method:"POST",
        headers:{"Content-Type":"application/json","Authorization":`Bearer ${localStorage.getItem('authToken')}`},
        body:JSON.stringify(data)
      })
      .then(r=>r.json())
      .then(r=>{
        if(r.success) showMessage("validationMessage",r.message,"success");
        else showMessage("validationMessage",r.message,"error");
      })
      .catch(e=>showMessage("validationMessage","Erreur lors de la soumission","error"))
      .finally(()=>document.getElementById("submitAllBtn").disabled=false);
    }
    document.getElementById("submitAllBtn").addEventListener("click",submitAllData);

    // ENABLE/DISABLE sections
    function enableDoctorSections(enable){
      const ids=['diagCardBody','prescCardBody','notesCardBody','orientationCardBody','antecedentsCardBody','treatmentCardBody','explorationCardBody'];
      ids.forEach(id=>{
        const el=document.getElementById(id);
        if(el){
          el.style.opacity=enable?'1':'0.5';
          el.style.pointerEvents=enable?'auto':'none';
        }
      });
      document.querySelectorAll('textarea, .btn').forEach(el=>{
        el.disabled=!enable;
      });
      if(!enable){
        ['diagnosticInput','prescriptionInput','notesInput','orientationInput','antecedentsInput','treatmentInput','explorationInput']
        .forEach(id=>document.getElementById(id).value="");
      }
    }

    function clearDoctorUI(){
      currentIPP=null;currentVisitId=null;
      patientInfoDiv.innerHTML=`<div style="text-align:center"><i class="fas fa-qrcode"></i><p>Prêt à scanner</p></div>`;
      nurseDataDisplayDiv.style.display='none';
      enableDoctorSections(false);
      enableFullDictationSection(false);
    }

    function displayNurseData(obs,vitals){
      const c=nurseDataDisplayDiv;
      if((!obs||!obs.observation_text)&&(!vitals||!vitals.timestamp)){c.style.display='none';return;}
      let obsHtml='<div>Aucun</div>';
      if(obs&&obs.observation_text){
        obsHtml=`<p><strong>Observation (${formatDate(obs.observation_date_time,true)}):</strong> ${sanitizeInput(obs.observation_text)}</p>`;
      }
      let vitHtml='<div>Aucun</div>', lines=[];
      if(vitals&&vitals.timestamp){
        if(vitals.temperature!=null) lines.push(`<div><i class="fas fa-thermometer-half"></i> Température: ${vitals.temperature}°C</div>`);
        if(vitals.tension_systolic!=null&&vitals.tension_diastolic!=null) lines.push(`<div><i class="fas fa-heartbeat"></i> TA: ${vitals.tension_systolic}/${vitals.tension_diastolic} mmHg</div>`);
        if(vitals.heart_rate!=null) lines.push(`<div><i class="fas fa-heart"></i> FC: ${vitals.heart_rate}/min</div>`);
        if(vitals.spo2!=null) lines.push(`<div><i class="fas fa-lungs"></i> SpO₂: ${vitals.spo2}%</div>`);
        vitHtml=`<p><strong>Signes Vitaux (${formatDate(vitals.timestamp,true)}):</strong></p>${lines.join('')}`;
      }
      c.style.display='block';
      c.innerHTML=`<h4><i class="fas fa-user-nurse"></i> Données Infirmières</h4>${obsHtml}${vitHtml}`;
    }

    // LOAD patient
    function loadPatient(ipp){
      currentIPP=ipp;
      patientInfoDiv.innerHTML='<p><i class="fas fa-spinner fa-spin"></i> Chargement...</p>';
      nurseDataDisplayDiv.style.display='none';
      enableDoctorSections(false); enableFullDictationSection(false);
      fetchWithAuth(`${BASE_URL}${GET_PATIENT_DATA_ENDPOINT}?ipp=${ipp}`)
      .then(res=>{
        if(!res || res.success===false || !res.patientData) throw new Error(res.message||"Données invalides");
        currentVisitId=res.visitId;
        const p=res.patientData;
        patientInfoDiv.innerHTML=`
          <div><strong>Nom:</strong> ${sanitizeInput(p.nom||'-')}</div>
          <div><strong>Prénom:</strong> ${sanitizeInput(p.prenom||'-')}</div>
          <div><strong>IPP:</strong> ${sanitizeInput(ipp)}</div>
          <div><strong>Visite:</strong> ${sanitizeInput(res.visitId)}</div>
          <div><strong>CIN:</strong> ${sanitizeInput(p.cin||'-')}</div>
          <div><strong>Tél:</strong> ${sanitizeInput(p.telephone||'-')}</div>
          <div><strong>Adresse:</strong> ${sanitizeInput(p.adresse||'-')}</div>
          <div><strong>Mutuelle:</strong> ${sanitizeInput(p.mutuelle||'Aucune')}</div>
          <div><strong>Naissance:</strong> ${formatDate(p.date_naissance)}</div>
          <div><strong>Sexe:</strong> ${sanitizeInput(p.sexe==='M'?'Homme':p.sexe==='F'?'Femme':'-')}</div>
        `;
        displayNurseData(res.nurseObservations||{},res.vitalSigns||{});
        enableDoctorSections(true);
        enableFullDictationSection(true);
      })
      .catch(e=>{
        patientInfoDiv.innerHTML=`<p style="color:red">Erreur: ${e.message}</p>`;
        clearDoctorUI();
      });
    }

    // AUDIO recording
    function startRecording(field){
      if(!currentIPP||!currentVisitId){alert("Chargez patient");return;}
      if(mediaRecorder&&mediaRecorder.state==='recording')return;
      audioChunks=[];
      recordingField=field;
      const statusEl=document.getElementById(field+'Status');
      let startBtn, stopBtn;
      if(field==='diagnosis'){startBtn=document.getElementById('startDiagRecordBtn');stopBtn=document.getElementById('stopDiagRecordBtn');}
      else if(field==='prescription'){startBtn=document.getElementById('startPrescRecordBtn');stopBtn=document.getElementById('stopPrescRecordBtn');}
      else if(field==='antecedents'){startBtn=document.getElementById('startAntecedentsRecordBtn');stopBtn=document.getElementById('stopAntecedentsRecordBtn');}
      else if(field==='treatment'){startBtn=document.getElementById('startTreatmentRecordBtn');stopBtn=document.getElementById('stopTreatmentRecordBtn');}
      else if(field==='notes'){startBtn=document.getElementById('startNotesRecordBtn');stopBtn=document.getElementById('stopNotesRecordBtn');}
      else if(field==='orientation'){startBtn=document.getElementById('startOrientationRecordBtn');stopBtn=document.getElementById('stopOrientationRecordBtn');}
      else if(field==='exploration'){startBtn=document.getElementById('startExplorationRecordBtn');stopBtn=document.getElementById('stopExplorationRecordBtn');}
      statusEl.innerHTML='<i class="fas fa-microphone-alt fa-beat"></i> REC...';
      statusEl.style.display='inline-flex';
      startBtn.disabled=true; stopBtn.disabled=false;
      navigator.mediaDevices.getUserMedia({audio:true})
      .then(stream=>{
        mediaRecorder=new MediaRecorder(stream);
        mediaRecorder.ondataavailable=e=>{if(e.data.size)audioChunks.push(e.data)};
        mediaRecorder.onstop=()=>handleRecordingStop(stream);
        mediaRecorder.onerror=err=>{
          console.error(err);
          statusEl.innerHTML='<i class="fas fa-times-circle"></i> Err';
          startBtn.disabled=false; stopBtn.disabled=true;
          recordingField=null; stream.getTracks().forEach(t=>t.stop());
        };
        mediaRecorder.start();
      })
      .catch(err=>{
        console.error(err);
        alert("Micro non dispo: "+err.message);
        statusEl.innerHTML='<i class="fas fa-exclamation-triangle"></i> Err';
        startBtn.disabled=false; stopBtn.disabled=true;
        recordingField=null;
      });
    }

    function stopRecording(field){
      const statusEl=document.getElementById(field+'Status');
      if(mediaRecorder&&mediaRecorder.state==='recording'&&recordingField===field){
        mediaRecorder.stop();
        statusEl.innerHTML='<i class="fas fa-spinner fa-spin"></i> Arrêt...';
      }
    }

    function handleRecordingStop(stream){
      const field=recordingField;
      const statusEl=document.getElementById(field+'Status');
      let startBtn, stopBtn;
      if(field==='diagnosis'){startBtn=document.getElementById('startDiagRecordBtn');stopBtn=document.getElementById('stopDiagRecordBtn');}
      else if(field==='prescription'){startBtn=document.getElementById('startPrescRecordBtn');stopBtn=document.getElementById('stopPrescRecordBtn');}
      else if(field==='antecedents'){startBtn=document.getElementById('startAntecedentsRecordBtn');stopBtn=document.getElementById('stopAntecedentsRecordBtn');}
      else if(field==='treatment'){startBtn=document.getElementById('startTreatmentRecordBtn');stopBtn=document.getElementById('stopTreatmentRecordBtn');}
      else if(field==='notes'){startBtn=document.getElementById('startNotesRecordBtn');stopBtn=document.getElementById('stopNotesRecordBtn');}
      else if(field==='orientation'){startBtn=document.getElementById('startOrientationRecordBtn');stopBtn=document.getElementById('stopOrientationRecordBtn');}
      else if(field==='exploration'){startBtn=document.getElementById('startExplorationRecordBtn');stopBtn=document.getElementById('stopExplorationRecordBtn');}
      stopBtn.disabled=true;
      if(!audioChunks.length){
        statusEl.innerHTML='<i class="fas fa-exclamation-circle"></i> Vide';
        startBtn.disabled=false;
        setTimeout(()=>{statusEl.style.display='none';},3000);
      } else {
        const blob=new Blob(audioChunks,{type:'audio/webm'});
        statusEl.innerHTML='<i class="fas fa-spinner fa-spin"></i> Transc...';
        sendAudioToAI(blob,field);
      }
      recordingField=null; mediaRecorder=null; stream.getTracks().forEach(t=>t.stop());
    }

    function getFieldConfig(field){
      return {
        diagnosis:{apiEndpoint:TRANSCRIBE_DIAGNOSIS_ENDPOINT,messageId:'diagnosisStatus'},
        prescription:{apiEndpoint:TRANSCRIBE_PRESCRIPTION_ENDPOINT,messageId:'prescriptionStatus'},
        antecedents:{apiEndpoint:TRANSCRIBE_ANTECEDENTS_ENDPOINT,messageId:'antecedentsStatus'},
        treatment:{apiEndpoint:TRANSCRIBE_TREATMENT_ENDPOINT,messageId:'treatmentStatus'},
        notes:{apiEndpoint:TRANSCRIBE_NOTES_ENDPOINT,messageId:'notesStatus'},
        orientation:{apiEndpoint:TRANSCRIBE_ORIENTATION_ENDPOINT,messageId:'orientationStatus'},
        exploration:{apiEndpoint:TRANSCRIBE_EXPLORATION_ENDPOINT,messageId:'explorationStatus'}
      }[field];
    }

    function sendAudioToAI(blob,field){
      const cfg=getFieldConfig(field);
      const url=BASE_URL+cfg.apiEndpoint;
      const fd=new FormData();
      fd.append('audio',blob,`${field}_${Date.now()}.webm`);
      fd.append('ipp',currentIPP);
      fd.append('visit_id',currentVisitId);
      fetchWithAuth(url,{method:'POST',body:fd})
      .then(res=>{
        let obj=Array.isArray(res)?res[0]:res;
        if(obj.success&&typeof obj.transcript==='string'){
          const map={'diagnosis':'diagnosticInput','prescription':'prescriptionInput','antecedents':'antecedentsInput','treatment':'treatmentInput','notes':'notesInput','orientation':'orientationInput','exploration':'explorationInput'};
          document.getElementById(map[field]).value=obj.transcript;
          showMessage(cfg.messageId,'Transcription OK','success');
        } else throw new Error(obj.message||'Transcription err');
      })
      .catch(e=>showMessage(cfg.messageId,e.message,'error'))
      .finally(()=>{document.getElementById(cfg.messageId).style.display='inline-flex';});
    }

    function submitDiagnostic(){
      const txt=document.getElementById('diagnosticInput').value;
      if(!txt||!currentIPP||!currentVisitId){showMessage('diagnosisStatus','Vide ou patient non chargé','warning');return;}
      showMessage('diagnosisStatus','','info');
      fetchWithAuth(BASE_URL+UPDATE_DIAGNOSIS_ENDPOINT,{method:'POST',body:JSON.stringify({ipp:currentIPP,visit_id:currentVisitId,diagnostic:txt})})
      .then(_=>showMessage('diagnosisStatus','Enregistré','success'))
      .catch(e=>showMessage('diagnosisStatus',e.message,'error'));
    }

    function submitPrescription(){
      const txt=document.getElementById('prescriptionInput').value;
      if(!txt||!currentIPP||!currentVisitId){showMessage('prescriptionStatus','Vide ou patient non chargé','warning');return;}
      showMessage('prescriptionStatus','','info');
      fetchWithAuth(BASE_URL+SUBMIT_PRESCRIPTION_AI_ENDPOINT,{method:'POST',body:JSON.stringify({ipp:currentIPP,visit_id:currentVisitId,prescription:txt})})
      .then(res=>{
        let sug=Array.isArray(res)?res[0].output:res.suggestion;
        if(!sug) throw new Error('Réponse IA invalide');
        // display IA suggestion...
      })
      .catch(e=>showMessage('prescriptionStatus',e.message,'error'));
    }

    function validatePrescription(){ /* implement as before if needed */ }

    // QR SCANNER
    function updateScanStatus(msg,type='info'){showMessage('validationMessage',msg,type);}
    if(scanButton) scanButton.onclick=async()=>{
      if(!scanning){
        try{
          scannerContainer.style.display='block';
          updateScanStatus('Recherche caméra...','loading');
          currentStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
          video.srcObject=currentStream;
          await video.play();
          updateScanStatus('Scannez le QR','info');
          scanButton.innerHTML='<i class="fas fa-stop-circle"></i> Arrêter Scan';
          scanButton.classList.replace('btn-primary','btn-outline');
          scanning=true;
          scanTimeout=setTimeout(()=>{ if(scanning){ updateScanStatus('Aucun code'); stopScanner(); } },30000);
          requestAnimationFrame(tick);
        }catch(e){
          updateScanStatus('Erreur caméra: '+e.message,'error');
          stopScanner();
        }
      } else {
        stopScanner();
        updateScanStatus('Scan arrêté','info');
      }
    };
    function stopScanner(){
      clearTimeout(scanTimeout);
      if(currentStream) currentStream.getTracks().forEach(t=>t.stop());
      video.srcObject=null;
      scannerContainer.style.display='none';
      scanButton.innerHTML='<i class="fas fa-qrcode"></i> Scanner QR';
      scanButton.classList.replace('btn-outline','btn-primary');
      scanning=false; currentStream=null;
    }
    function tick(){
      if(!scanning||!video||video.readyState<2){ if(scanning) requestAnimationFrame(tick); return; }
      const c=document.createElement('canvas');
      c.width=video.videoWidth; c.height=video.videoHeight;
      const ctx=c.getContext('2d');
      ctx.drawImage(video,0,0);
      try{
        const img=ctx.getImageData(0,0,c.width,c.height);
        const code=jsQR(img.data,img.width,img.height,{inversionAttempts:'dontInvert'});
        if(code){ stopScanner(); processScannedQrCode(code.data); }
        else requestAnimationFrame(tick);
      }catch(e){ requestAnimationFrame(tick); }
    }
    function processScannedQrCode(data){
      updateScanStatus('Traitement...','loading');
      try{
        const url=new URL(data);
        if(data.startsWith(QR_TARGET_BASE_URL)){
          const ipp=url.searchParams.get('ipp');
          if(ipp){ updateScanStatus('Chargement IPP '+ipp,'success'); loadPatient(ipp); }
          else{ updateScanStatus('IPP manquant','error'); clearDoctorUI(); }
        } else { updateScanStatus('QR non reconnu','error'); clearDoctorUI(); }
      }catch(e){
        updateScanStatus('Format QR invalide','error');
        clearDoctorUI();
      }
    }

    window.onload=()=>{
      if(!localStorage.getItem('authToken')){ window.location.href=LOGIN_PAGE_URL; return; }
      document.body.classList.add('loaded');
      const ipp=new URLSearchParams(window.location.search).get('ipp');
      if(ipp) loadPatient(ipp);
      else clearDoctorUI();
    };
  </script>
</body>
</html>
