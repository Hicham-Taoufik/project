<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="description" content="Dashboard de réception pour la gestion des patients – MediClinic" />
  <meta name="theme-color" content="#ffffff" />
  <title>Réception – MediClinic</title>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    rel="stylesheet"
  />

  <!-- Select2 CSS -->
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-beta.1/css/select2.min.css"
    rel="stylesheet"
  />

  <!-- Local CSS -->
  <link rel="stylesheet" href="style.css" />

  <style>
    @media print {
      .no-print { display: none !important; }
      button { display: none !important; }
    }
  </style>
</head>
<body>
  <a href="#main-content" class="skip-link">Passer au contenu principal</a>
  <div class="container">
    <header class="header">
      <div class="header-main-content">
        <div class="logo">
          <img src="./clinique-nakhil-logo-horizontal.webp" alt="MediClinic Logo" class="logo-img" width="180" height="40" />
        </div>
        <h1 class="header-title">Réception</h1>
      </div>
      <div class="header-logout">
        <button type="button" class="btn btn-outline logout-btn no-print" id="logoutBtn">
          <i class="fas fa-sign-out-alt"></i> Déconnexion
        </button>
      </div>
    </header>

    <main id="main-content" class="flex-row">
      <div class="flex-col">
        <section class="card" aria-labelledby="create-patient-heading">
          <div class="card-header">
            <h2 id="create-patient-heading" class="card-title">
              <i class="fas fa-user-plus"></i> Créer un Patient
            </h2>
            <div class="card-actions" aria-hidden="true">
              <i class="fas fa-pen"></i>
            </div>
          </div>
          <div class="card-body">
            <div class="id-capture-section mb-4 no-print">
              <button id="captureIdButton" type="button" class="btn btn-primary">
                <i class="fas fa-camera"></i> Scanner CIN
              </button>
              <div id="idCaptureContainer" class="hidden">
                <!-- CIN capture UI... -->
              </div>
            </div>

            <form id="createForm" novalidate>
              <!-- form inputs for nom, prenom, cin, telephone, adresse, ville, date_naissance, sexe, mutuelle, doctor -->
              <div class="form-submit-button">
                <button type="submit" class="btn btn-success" id="createPatientBtn">
                  <i class="fas fa-plus-circle"></i> Créer Patient &amp; Démarrer Visite
                </button>
              </div>
              <div id="message" class="message" role="alert" aria-live="polite"></div>
            </form>

            <div id="createResult" style="display:none;"></div>
          </div>
        </section>
      </div>

      <div class="flex-col">
        <section class="card" aria-labelledby="search-patient-heading">
          <!-- search patient UI... -->
        </section>
        <section class="card" aria-labelledby="recent-patients-heading">
          <!-- recent patients UI... -->
        </section>
      </div>
    </main>

    <footer class="footer no-print">
      <p>&copy; 2025 MediClinic. Tous droits réservés.</p>
    </footer>
  </div>

  <div id="toast" class="toast" role="alert" aria-live="assertive"></div>

  <div id="patientModal" class="modal" aria-labelledby="modal-title" aria-modal="true" role="dialog">
    <!-- patient modal UI... -->
  </div>

  <!-- Dependencies -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-beta.1/js/select2.min.js"></script>

  <script>
    (() => {
      // Configuration
      const CONFIG = {
        API_BASE_URL: "https://workflows.aphelionxinnovations.com",
        TOKEN_KEY: "authToken",
        LOGIN_PAGE_URL: "https://hicham-taoufik.github.io/login/",
        MESSAGE_DISPLAY_TIME: 7000,
        TOAST_DISPLAY_TIME: 4000,
        CREATE_PATIENT_ENDPOINT: "/webhook/create-patient",
      };

      // DOM
      const DOM = {
        body: document.body,
        createForm: document.getElementById("createForm"),
        createPatientBtn: document.getElementById("createPatientBtn"),
        createResultDiv: document.getElementById("createResult"),
        messageDiv: document.getElementById("message"),
        logoutBtn: document.getElementById("logoutBtn"),
      };

      // Toast
      const showToast = (msg, type="success") => {
        const toast = document.getElementById("toast");
        toast.innerHTML = (type==="success"?
          '<i class="fas fa-check-circle"></i> ': '<i class="fas fa-exclamation-circle"></i> ') + msg;
        toast.className = `toast ${type} show`;
        setTimeout(() => toast.classList.remove("show"), CONFIG.TOAST_DISPLAY_TIME);
      };

      // Message
      const showMessage = (id, msg, type="info") => {
        const el = document.getElementById(id);
        if (!el) return;
        el.innerHTML = msg;
        el.style.display = msg ? "block" : "none";
        el.className = `message message-${type}`;
        if (id==="message" && msg && (type==="info"||type==="success")) {
          setTimeout(()=>{ el.style.display="none"; }, CONFIG.MESSAGE_DISPLAY_TIME);
        }
      };

      const logout = () => {
        localStorage.removeItem(CONFIG.TOKEN_KEY);
        showToast("Déconnecté.", "success");
        setTimeout(()=>location.href=CONFIG.LOGIN_PAGE_URL,500);
      };
      DOM.logoutBtn?.addEventListener("click", logout);

      // Auth fetch
      async function fetchWithAuth(url, opt={}) {
        const token=localStorage.getItem(CONFIG.TOKEN_KEY);
        if(!token) { logout(); throw "No token"; }
        const headers = { ...(opt.headers||{}), 'Authorization':`Bearer ${token}` };
        if(opt.body && !(opt.body instanceof FormData)) headers['Content-Type']='application/json';
        const res = await fetch(url,{...opt,headers});
        if(!res.ok) throw await res.text();
        const ct=res.headers.get("content-type")||"";
        return ct.includes("json")?res.json():res.text();
      }

      // QR Print helper
      window.printQRCode = function(qrUrl) {
        const w=window.open("","_blank","width=400,height=450");
        if(!w){alert("Autorisez pop‑ups.");return;}
        w.document.write(`
          <html><head>
            <style>
              body{margin:20px;text-align:center;font-family:sans-serif;}
              img{max-width:250px;border:1px solid #ccc;padding:5px;}
              @media print{button{display:none}}
            </style>
          </head>
          <body>
            <img src="${qrUrl}" alt="QR Code"/>
            <script>
              window.onload=()=>{
                setTimeout(()=>{
                  window.print();
                  setTimeout(()=>window.close(),500);
                },500);
              };
            <\/script>
          </body></html>`);
        w.document.close();
      };

      // Generate QR data
      function generateQrData(ipp) {
        const target=`app://medilink/patient?ipp=${encodeURIComponent(ipp)}`;
        const img=`https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(target)}`;
        return img;
      }

      // Create Patient handler
      async function handleCreatePatient(e) {
        e.preventDefault();
        showMessage("message","Création…","info");
        DOM.createPatientBtn.disabled=true;
        DOM.createResultDiv.style.display="none";

        const f=DOM.createForm;
        const payload={
          nom:f.nom.value.trim(),
          prenom:f.prenom.value.trim(),
          cin:f.cin.value.trim()||null,
          telephone:f.telephone.value.trim(),
          adresse:f.adresse.value.trim(),
          ville:f.ville.value.trim(),
          date_naissance:f.date_naissance.value,
          sexe:f.sexe.value,
          mutuelle:f.mutuelle.value||null,
          doctor:f.doctor.value||null
        };

        try {
          const resp=await fetchWithAuth(
            CONFIG.API_BASE_URL+CONFIG.CREATE_PATIENT_ENDPOINT,
            { method:"POST", body:JSON.stringify(payload) }
          );
          if(!resp.success||!resp.ipp) throw resp.message||"Échec.";
          const qrImg=generateQrData(resp.ipp);
          const html=`
            <div class="patient-result-card">
              <h3>Patient créé</h3>
              <ul class="patient-info-list">
                <li><strong>Nom:</strong> ${payload.nom}</li>
                <li><strong>Prénom:</strong> ${payload.prenom}</li>
                <li><strong>IPP:</strong> ${resp.ipp}</li>
              </ul>
              <div class="qr-section">
                <img src="${qrImg}" alt="QR Code" loading="lazy"/>
                <div class="qr-buttons no-print" style="margin-top:10px;">
                  <button class="btn btn-secondary btn-sm" onclick="printQRCode('${qrImg}')">
                    <i class="fas fa-print"></i> Imprimer QR Code
                  </button>
                </div>
              </div>
            </div>`;
          DOM.createResultDiv.innerHTML=html;
          DOM.createResultDiv.style.display="block";
          showToast(resp.message||"Patient créé !","success");
          f.reset();
        } catch(err) {
          console.error(err);
          showMessage("message","Erreur : "+err,"error");
        } finally {
          DOM.createPatientBtn.disabled=false;
        }
      }

      document.addEventListener("DOMContentLoaded",()=>{
        if(!localStorage.getItem(CONFIG.TOKEN_KEY)) logout();
        DOM.createForm.addEventListener("submit", handleCreatePatient);
      });
    })();
  </script>
</body>
</html>
